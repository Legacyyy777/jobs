# 🚀 Развертывание painter_bot

## Автоматическое развертывание

Система теперь **автоматически** создает базу данных и таблицы при первом запуске. Поддерживает полную очистку через `docker compose down -v`!

### Быстрый старт

1. **Настройте переменные окружения:**
```bash
cp env.example .env
# Отредактируйте .env файл, добавьте BOT_TOKEN и другие настройки
```

2. **Запустите систему:**
```bash
docker-compose up -d
```

3. **Готово!** 🎉

## Что происходит автоматически

### ✅ При первом запуске:
- PostgreSQL сервер запускается
- Создается база данных `painter_bot` (если не существует)
- Создаются все необходимые таблицы
- Создаются индексы для оптимизации
- Бот подключается к базе данных

### ✅ При проблемах с БД:
- Бот продолжает работать в ограниченном режиме
- Пользователи получают уведомление о временной недоступности
- Автоматические попытки восстановления соединения
- Graceful degradation - никаких крашей

### ✅ Мониторинг:
- Периодическая проверка состояния БД (каждые 5 минут)
- Автоматическое переподключение при восстановлении
- Подробное логирование всех событий

## Проверка работы

```bash
# Проверьте статус контейнеров
docker-compose ps

# Посмотрите логи
docker logs painter_bot --tail 20
docker logs painter_bot_db --tail 20

# Проверьте базу данных
docker exec painter_bot_db psql -U postgres -d painter_bot -c "SELECT COUNT(*) FROM users;"
```

## Возможные проблемы и решения

### Проблема: Бот не запускается
**Решение:** Проверьте логи
```bash
docker logs painter_bot
```

### Проблема: База данных не создается
**Решение:** Перезапустите контейнеры
```bash
docker-compose restart
```

### Проблема: Бот работает без БД
**Решение:** Это нормально! Бот уведомит пользователей о временной недоступности и автоматически восстановится при доступности БД.

## Архитектура системы

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Telegram Bot  │    │   Middleware     │    │   PostgreSQL    │
│                 │    │   (DB Check)     │    │                 │
│  - Handlers     │◄──►│                  │◄──►│  - painter_bot  │
│  - FSM States   │    │  - Health Check  │    │  - Auto Create  │
│  - Graceful Deg │    │  - Auto Reconnect│    │  - Tables       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## Особенности

- 🔄 **Автоматическое восстановление** - никаких ручных действий
- 🛡️ **Graceful degradation** - бот работает даже без БД
- 📊 **Мониторинг** - постоянный контроль состояния
- 🚀 **Zero-downtime deployment** - обновления без простоя
- 📝 **Подробное логирование** - легко диагностировать проблемы

## Команды для управления

```bash
# Запуск
docker-compose up -d

# Перезапуск
docker-compose restart

# Остановка (с сохранением данных)
docker-compose down

# Полная очистка (удаляет все данные)
docker-compose down -v

# Просмотр логов
docker-compose logs -f

# Обновление
docker-compose pull
docker-compose up -d

# Тестирование восстановления
chmod +x test_recovery.sh
./test_recovery.sh
```

## Полная очистка и восстановление

Система поддерживает полную очистку через `docker compose down -v`:

```bash
# Полная очистка
docker-compose down -v

# Автоматическое восстановление
docker-compose up -d
```

После этого:
- ✅ PostgreSQL пересоздается с нуля
- ✅ База данных `painter_bot` создается автоматически
- ✅ Все таблицы и индексы создаются
- ✅ Бот подключается и работает

## Мониторинг в продакшене

Рекомендуется настроить мониторинг:
- Логи Docker контейнеров
- Статус health check
- Метрики PostgreSQL
- Уведомления о сбоях

Система готова к продакшену! 🎯
